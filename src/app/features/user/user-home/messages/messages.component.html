<div class="message-container flex">

  <!-- Left  -->
  <div class="left col-3 p-0 flex flex-column">
    <!-- Username Header -->
    <div class="flex justify-content-between align-items-center p-2">
      <div class="flex justify-content-between align-items-center gap-2">
        <app-avatar [userId]="currentUser?.id" [width]="48"></app-avatar>
        <h3>{{currentUser?.username}}</h3>
      </div>
      <i (click)="isDialogVisible = true" class="fa-regular fa-pen-to-square cursor-pointer"></i>
    </div>

    <p-divider></p-divider>

    <!-- Message Room List -->
    <div class="flex-1 overflow-hidden flex flex-column">
      <h4 class="px-2">Messages</h4>
      <div class="flex-1 primary-scrollbar overflow-y-scroll">
        <div *ngFor="let messageroom of messageRooms"
          (click)="selectMessageRoom(messageroom)"
          [routerLink]="['inbox', messageroom.id]"
          routerLinkActive="active"
          class="message-item py-3 px-2">
          <div class="flex align-items-center gap-2">
            <app-avatar [userId]="messageroom.avatarURL" [width]="48"></app-avatar>
            <div class="w-full" [ngStyle]="{ 'max-width': (messageroom.unSeenCount && messageroom.unSeenCount > 0) ? 'calc(100% - 48px - 0.5rem - 20px - 0.5rem)' : 'calc(100% - 48px - 0.5rem)'}">
              <p *ngIf="currentUser.username"
                title="{{messageroom.name}}"
                class="my-1 line-clamp"
                style="word-break: break-word;">
                {{messageroom.name}}
              </p>
              <!-- last message -->
              <div *ngIf="messageroom.lastMessage" class="preview-message-content flex 1 flex align-items-center gap-1 text-gray-500">
                <!-- if type is text, show message -->
                <small *ngIf="!messageroom.lastMessage?.type?.startsWith('NOTIFICATION') && messageroom.lastMessage?.type == MessageContentTypeEnum.TEXT" 
                  style="text-overflow: ellipsis; white-space: nowrap; overflow: hidden;"
                  class="line-clamp"
                  [innerHTML]="messageroom.lastMessage?.message">
                </small>
                <!-- if type is not text, show user sent a sticker or photo -->
                <small *ngIf="!messageroom.lastMessage?.type?.startsWith('NOTIFICATION') && messageroom.lastMessage?.type != MessageContentTypeEnum.TEXT" 
                  style="text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">
                  <ng-container>
                    {{messageroom.lastMessage?.user?.username == this.currentUser.username ? 'You' : messageroom.lastMessage?.user?.username}}
                    sent a 
                    {{messageroom.lastMessage?.type == MessageContentTypeEnum.STICKER ? 'sticker' : 'photo'}}.
                  </ng-container>
                </small>
                <!-- if type is notification, show notification -->
                <ng-container *ngIf="messageroom.lastMessage?.type?.startsWith('NOTIFICATION')">
                  <app-message-item class="notification flex-1" style="width: 10px;" 
                    [messageContent]="messageroom.lastMessage"
                    [currentUser]="currentUser"
                    [messageRoom]="messageroom"
                    [isLastSeen]="false">
                  </app-message-item>
                </ng-container>
                <small>Â·</small>
                <!-- date sent -->
                <small>{{messageroom.lastMessage?.dateSent | dateAgoPipe: 'd'}}</small>
              </div>
            </div>
            <!-- unSeenCount -->
            <span *ngIf="messageroom.unSeenCount && messageroom.unSeenCount > 0" style="min-width: 1.25rem; min-height: 1.25rem; font-size: 0.75rem;" class="ml-auto bg-red-500 border-circle text-white flex justify-content-center align-items-center">
              {{messageroom.unSeenCount}}
            </span>
          </div>
        </div>  
      </div>
    </div>
  </div>

  <p-divider [layout]="'vertical'"></p-divider>

  <!-- Message Content -->
  <div class="right col-9 message-content p-0">
    <!-- <router-outlet></router-outlet> -->
    <app-message-content-list *ngIf="selectedMessageRoom" 
      [messageRoom]="selectedMessageRoom"
      [currentUser]="currentUser"
      (sendFirstMessageEvent)="sendFirstMessageEvent()"
      (updateMessageRoomNameEvent)="updateMessageRoomName($event)">
    </app-message-content-list>
  </div>
</div>



<!-- New message dialog -->
<app-select-user-dialog *ngIf="currentUser && currentUser.id"
  [isDialogVisible]="isDialogVisible"
  dialogTitle="New message"
  dialogDescription="To..."
  dialogSubmitLabel="Chat"
  (selectedUsersEvent)="chat($event)"
  (visibleHide)="isDialogVisible = false">
</app-select-user-dialog>
